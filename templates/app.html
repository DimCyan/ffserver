<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8">
    <title>Bucket</title>
    <link rel='shortcut icon' type='image/x-icon' href="/static/img/favicon.ico">
    <!-- <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css"> -->
    <link rel="stylesheet" href="/static/styles/theme.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <!-- <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script> -->
    <style>
        /* .table {
            outline-style: solid;
            outline-width: 1px;
            outline-color: #d0d7de;
            border-radius: 6px !important;
        }

        .table>tbody>tr {
            padding: 8px 16px;
        }

        a:hover {
            text-decoration: none;
        } */
    </style>
</head>

<body>
    <div id="app">
        <div class="header">
            <div class="header-wrapper">
                <div class="logo">
                    <a class="logo-link" href="https://github.com/DimCyan/ffserver">FFServer</a>
                </div>

                <form id="upload-file" enctype="multipart/form-data">
                    <div class="uploader">
                        <div class="file-input">
                            <input type="file" id="fileobj" required />
                            <div class="out">
                                <button type="button">
                                    <i class="iconfont icon-file-plus"></i>
                                </button>
                                <div class="text">No files selected</div>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn"> <i class="iconfont icon-upload"></i> Upload</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="file-content">
            <div class="routes">
                <ul class="breadcrumb">
                    <li class="all">
                        <a href="/">All Files</a>
                    </li>
                </ul>
            </div>
            {% if obj_list == [] %}
            <div class="alert">
                <div class="empty">
                    <i class="iconfont icon-empty"></i>
                </div>
                This folder is empty!
                <br>
                <a class="back" href="javascript:history.back();" class="alert-link">Go Back</a>
            </div>
            {% else %}
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Name</th>
                        <th style="width: 30%">ModifyTime</th>
                        <th style="width: 30%" class="text-right">Size</th>
                    </tr>
                </thead>
                <tbody>
                    {% for obj in obj_list %}
                    <tr>
                        <td>
                            <a class="objname" href="{{obj.file_name}}">
                                {{ obj.type }} {{obj.file_name}}
                            </a>
                        </td>
                        <td>
                            {{obj.modify_time}}
                        </td>
                        <td class="text-right">
                            {% if obj.type == 'dir' %}
                            ~
                            {% else %}
                            {{obj.size}}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    <script>
        $(document).ready(function () {

            $('.file-input').on('click', '.out', function () {
                $(this).parent().find('input[type="file"]').click()
            })
            $('.file-input').on('change', 'input[type="file"]', function () {
                var file = this.files[0]
                $(this).parent().attr('title', file.name)
                $(this).parent().find('.out .text').html(file.name)
            })

            // modify breadcrumb
            var curWwwPath = window.document.location.href;
            var pathName = window.document.location.pathname;
            var pos = curWwwPath.indexOf(pathName);
            var localhostPath = curWwwPath.substring(0, pos);
            var path_list = pathName.split("/").filter(function (s) {
                return s && s.trim();
            });
            for (let i = 1; i < path_list.length; i++) {
                if (i == path_list.length - 1) {
                    $('.breadcrumb').append('<li class="active" >' + path_list[i] + '</li>');
                } else {
                    $('.breadcrumb').append('<li>' + '<a href=' + genBreadcrumbPath(i) + '>' + path_list[i] +
                        '</a>' + '</li>');
                }
            };

            function genBreadcrumbPath(crumb_num) {
                var final_path = localhostPath + '/' + path_list[0];
                for (let i = 1; i <= crumb_num; i++) {
                    final_path = final_path + '/' + path_list[i];
                };
                return final_path;
            };

            function genRestPath() {
                var restPath = '';
                for (let i = 1; i < path_list.length; i++) {
                    restPath = restPath + '/' + path_list[i];
                };
                return restPath;
            };
            // modify timestamp
            function timeStamp2String(time) {
                var datetime = new Date();
                datetime.setTime(time * 1000);
                var year = datetime.getFullYear();
                var month = datetime.getMonth() + 1;
                var date = datetime.getDate();
                var hour = datetime.getHours();
                var minute = datetime.getMinutes();
                var second = datetime.getSeconds();
                return year + "-" + month + "-" + date + " " + hour + ":" + minute + ":" + second;
            };
            $('tbody tr td:nth-child(2)').each(function () {
                $(this).html(timeStamp2String($(this).text()));
            });
            // modify object href attribute
            $('tbody tr td:nth-child(1)').each(function () {
                $(this).find(".objname").attr("href", window.location.href + "/" + $(this).find(
                    ".objname").attr("href"));
            });
            // upload file method
            $('#upload-file').on('submit', function (e, form) {
                e.preventDefault();
                var restPath = genRestPath();
                var file = $('#fileobj')[0].files[0];
                let formData = new FormData(form);
                formData.append('rest_path', restPath);
                formData.append('file', file);

                $.ajax({
                    url: "/upload/uploader",
                    type: "POST",
                    'contentType': false,
                    'processData': false,
                    'mimeType': 'multipart/form-data',
                    'data': formData,
                    success: function () {
                        location.reload();
                    }
                });
            });
        });
    </script>
</body>

</html>